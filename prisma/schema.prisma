// schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String         @id @default(cuid())
  email             String         @unique
  phone             String?        @unique
  password          String
  fullName          String?
  firstName         String?
  lastName          String?
  gender            String?        
  country           String?        
  role              Role           @default(EMPLOYEE)
  company           String?
  permissions       Json?
  adminStatus       AdminStatus?   @default(PENDING)
  kycId             String?        
  verified          Boolean        @default(false)
  onboardingCompleted Boolean      @default(false)

  emailVerified     Boolean        @default(false)
  phoneVerified     Boolean        @default(false)
  otp               String?        
  otpExpires        DateTime?
  resetToken        String?        
  resetTokenExpires DateTime?
  requiresPasswordChange Boolean   @default(false)
  lastLogin         DateTime?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  
  // Relations
  refreshTokens     RefreshToken[]
  userPermissions   UserPermission[]
  profile           Profile?
  systemSettings    SystemSettings?
  
  // Add these new relations for onboarding
  onboardingProgress OnboardingProgress?
  kycDetails        KycDetails?
  studioSession     StudioSession?
  medicalRecord     MedicalRecord?
  
  // Add job-related relations
  jobsPosted        Job[]           @relation("EmployerJobs")
  jobApplications   JobApplication[] @relation("EmployeeApplications")
  sentMessages      ApplicationMessage[] @relation("MessageSenders")
  jobViews          JobView[]       @relation("JobViewers")
  savedJobs         SavedJob[]      @relation("SavedJobEmployees")
  
  // Contract relations
  employerContracts Contract[]      @relation("EmployerContracts")
  employeeContracts Contract[]      @relation("EmployeeContracts")
  
  // Notifications
  notifications     Notification[]
  
  // Wallet & Transactions
  wallet            Wallet?
  sentTransactions  Transaction[]   @relation("SenderTransactions")
  receivedTransactions Transaction[] @relation("ReceiverTransactions")
  
  // Support Tickets
  supportTickets    SupportTicket[] @relation("TicketCreator")
  assignedTickets   SupportTicket[] @relation("TicketAssignee")
  ticketMessages    TicketMessage[]
  
  // Training Progress
  classProgress     ClassProgress[]
  testAttempts      TestAttempt[]
  
  @@map("users")
}

model Profile {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  avatar      String?
  bio         String?
  timezone    String?  @default("Africa/Dar_es_Salaam")
  language    String?  @default("en")
  currency    String?  @default("USD")
  theme       String?  @default("light")
  address     String?
  idNumber    String?
  education   String?
  passportPhotoUrl String?
  studioPhotoUrl   String?
  notifications Json?  // Store notification preferences as JSON
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("profiles")
}

model SystemSettings {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  workingHours    Json?    // Store as {start: "09:00", end: "17:00"}
  businessSettings Json?   // Store business-specific settings
  securitySettings Json?   // Store 2FA, password policies, etc.
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("system_settings")
}

model Permission {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  category    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  userPermissions UserPermission[]
  
  @@map("permissions")
}

model UserPermission {
  id           String     @id @default(cuid())
  userId       String
  permissionId String
  granted      Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  
  // Relations
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  
  @@unique([userId, permissionId])
  @@map("user_permissions")
}

model OtpVerification {
  id        String   @id @default(cuid())
  email     String?
  phone     String?
  otp       String   
  type      OtpType  
  expiresAt DateTime
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
  
  @@map("otp_verifications")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  @@map("refresh_tokens")
}

// Onboarding models
model OnboardingProgress {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  currentStep Int      @default(1)
  completed   Boolean  @default(false)
  data        Json?    // Store all onboarding data including KYC details
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  completedSteps Int[]   @default([])  // Make sure this exists
  
  @@map("onboarding_progress")
}

model KycDetails {
  id                String   @id @default(cuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Personal Details
  dateOfBirth       DateTime?
  county            String?
  physicalAddress   String?
  
  // Identity Details
  idNumber          String?
  idDocumentFront   String?
  idDocumentBack    String?
  selfieUrl         String?
  passportNumber    String?
  passportExpiry    DateTime?
  nextOfKinName     String?
  nextOfKinPhone    String?
  
  // Verification Status
  idVerified        Boolean @default(false)
  faceVerified      Boolean @default(false)
  paymentVerified   Boolean @default(false)
  
  // Payment
  paymentStatus     String? @default("pending")
  paymentMethod     String? // 'mpesa' or 'pesapal'
  paymentCurrency   String? // 'KES', 'OMR', etc.
  paymentAmount     Float?
  
  // M-Pesa Payment (for workers)
  mpesaNumber       String?
  transactionCode   String?
  
  // Pesapal Payment (for employers)
  pesapalOrderTrackingId    String?
  pesapalMerchantReference  String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@map("kyc_details")
}

model StudioSession {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  studioName  String?
  studioLocation String?
  sessionDate DateTime?
  photos      Json?    // Store array of photo URLs
  faceMatchScore Float? // 0-100 score from face recognition
  verified    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("studio_sessions")
}

model MedicalRecord {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  hospitalName String?
  testDate    DateTime?
  results     Json?    // Store medical test results
  fitToWork   Boolean? @default(false)
  documentUrl String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("medical_records")
}

model Job {
  id                String   @id @default(cuid())
  employerId        String
  employer          User     @relation(fields: [employerId], references: [id], onDelete: Cascade, name: "EmployerJobs")
  
  // Basic Information
  title             String
  type              JobType  @default(FULL_TIME) // Added default value
  description       String
  status            JobStatus @default(DRAFT)
  category          JobCategory?
  agreeToTruth      Boolean  @default(false)
  agreeToTerms      Boolean  @default(false)
  availableFromType AvailableFromType?
  
  // Household Details
  residenceType     ResidenceType
  bedrooms          Int @default(1)
  bathrooms         Int
  totalFloors       Int @default(1)
  hasGarden         Boolean @default(false)
  hasPool           Boolean @default(false)
  squareMeters      Int?
  houseFeatures     HouseFeature[]
  
  // Family Details
  familyMembers     Int
  childrenCount     Int @default(0)
  childrenAges      String[]
  elderlyCare       Boolean @default(false)
  specialNeeds      Boolean @default(false)
  familyDetails     Json?    // Store detailed family info (age, disability)
  
  // Pet Details
  pets              String[] // Legacy, keep for now
  petDetails        Json?    // Store detailed pet info (type, housing)
  
  // Job Requirements
  duties            String[]
  experienceRequired ExperienceLevel
  languageRequirements String[]
  workingHours      String
  overtimeRequired  Boolean @default(false)
  accommodation     AccommodationType
  meals             MealsType
  vacationDays      Int @default(30)
  
  // Benefits & Certifications
  benefits          String[]
  certifications    String[]
  skills            String[]
  
  // Compensation & Location
  salary            Float
  salaryCurrency    String @default("OMR")
  location          String?
  city              String
  availableFrom     String?
  interviewRequired Boolean @default(true)
  
  // Additional Settings
  emergencySupport  Boolean @default(true)
  autoSalaryCalculation Boolean @default(true)
  
  // New Fields for Dynamic Job Posting
  questionnaire     Json?    // Stores family tree, disability, house info, etc.
  salaryBreakdown   Json?    // Stores the calculated salary components
  shortlistedEmployeeId String?   // ID of shortlisted employee
  additionalDuties Json?          // Free-form duties description
  
  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  postedAt          DateTime?
  closedAt          DateTime?
  
  // Relations
  applications      JobApplication[]
  views             JobView[]
  savedBy           SavedJob[]
  
  @@map("jobs")
}

model JobApplication {
  id          String      @id @default(cuid())
  jobId       String
  job         Job         @relation(fields: [jobId], references: [id], onDelete: Cascade)
  employeeId  String
  employee    User        @relation(fields: [employeeId], references: [id], onDelete: Cascade, name: "EmployeeApplications")
  
  // Application Details
  status      ApplicationStatus @default(PENDING)
  coverLetter String?
  isDraft     Boolean     @default(false)
  
  // Enhanced workflow fields with progress tracking
  currentStep ApplicationStep @default(APPLICATION_SUBMITTED)
  
  // Timestamps for each step
  applicationSubmittedAt DateTime @default(now())
  underReviewAt         DateTime?
  shortlistedAt         DateTime?
  interviewScheduledAt  DateTime?
  medicalRequestedAt    DateTime?
  medicalSubmittedAt    DateTime?
  medicalApprovedAt     DateTime?
  contractSentAt        DateTime?
  contractSignedAt      DateTime?
  visaAppliedAt         DateTime?
  visaApprovedAt        DateTime?
  flightTicketSentAt    DateTime?
  flightTicketReceivedAt DateTime?
  deploymentReadyAt     DateTime?
  
  // Document tracking
  passportVerified    Boolean @default(false)
  goodConductVerified Boolean @default(false)
  medicalVerified     Boolean @default(false)
  contractSigned      Boolean @default(false)
  visaApproved        Boolean @default(false)
  flightTicketSent    Boolean @default(false)
  
  // Medical document tracking
  medicalDocumentUrl  String?
  medicalSubmitted    Boolean @default(false)
  medicalApproved     Boolean @default(false)
  
  // Flight ticket tracking
  flightTicketUrl     String?
  flightTicketDetails Json?    // Store flight details
  
  // Interview details
  interviewDate       DateTime?
  interviewNotes      String?
  
  // Contract details
  contractUrl         String?
  contractDetails     Json?    // Store contract terms
  contract            Contract?
  
  // Timestamps
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  viewedAt    DateTime?
  
  // Relations
  messages    ApplicationMessage[]
  documents   ApplicationDocument[]
  
  @@unique([jobId, employeeId])
  @@map("job_applications")
}

model ApplicationMessage {
  id              String   @id @default(cuid())
  applicationId   String
  application     JobApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  senderId        String
  sender          User     @relation(fields: [senderId], references: [id], onDelete: Cascade, name: "MessageSenders")
  message         String
  isEmployer      Boolean
  createdAt       DateTime @default(now())
  
  @@map("application_messages")
}

model ApplicationDocument {
  id              String   @id @default(cuid())
  applicationId   String
  application     JobApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  documentType    String   // passport, medical, contract, etc.
  documentUrl     String
  verified        Boolean  @default(false)
  uploadedAt      DateTime @default(now())
  
  @@map("application_documents")
}

model JobView {
  id        String   @id @default(cuid())
  jobId     String
  job       Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  viewerId  String?
  viewer    User?    @relation(fields: [viewerId], references: [id], onDelete: Cascade, name: "JobViewers")
  createdAt DateTime @default(now())
  
  @@map("job_views")
}

model SavedJob {
  id         String   @id @default(cuid())
  jobId      String
  job        Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  employeeId String
  employee   User     @relation(fields: [employeeId], references: [id], onDelete: Cascade, name: "SavedJobEmployees")
  createdAt  DateTime @default(now())
  
  @@unique([jobId, employeeId])
  @@map("saved_jobs")
}

// Enums
enum JobType {
  FULL_TIME
  PART_TIME
  LIVE_OUT
  FLEXIBLE
}

enum JobStatus {
  DRAFT
  ACTIVE
  CLOSED
  EXPIRED
}

enum ResidenceType {
  APARTMENT
  VILLA
  DUPLEX
  MANSION
}

enum ExperienceLevel {
  NO_EXPERIENCE
  ONE_TO_TWO_YEARS
  THREE_TO_FIVE_YEARS
  FIVE_PLUS_YEARS
}

enum AccommodationType {
  PROVIDED
  NOT_PROVIDED
  SHARED
  PRIVATE
}

enum MealsType {
  INCLUDED
  NOT_INCLUDED
  PARTIAL
}


enum Role {
  EMPLOYER
  EMPLOYEE
  ADMIN
  SUPER_ADMIN
  HOSPITAL_ADMIN
  PHOTO_STUDIO_ADMIN
  EMBASSY_ADMIN
}

enum JobCategory {
  GENERAL_HOUSE_HELP
  ELDERLY_CARE
  CHILD_CARE
  COOKING_SPECIALIST
  HOUSE_MANAGER
}

enum OtpType {
  EMAIL
  PHONE
  LOGIN
  FORGOT_PASSWORD
  ADMIN_INVITE
}

enum AdminStatus {
  PENDING
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum AvailableFromType {
  IMMEDIATELY
  ONE_MONTH
  TWO_MONTHS
  SPECIFIC_DATE
}
// Add new enum for application steps
enum ApplicationStep {
  APPLICATION_SUBMITTED
  UNDER_REVIEW
  SHORTLISTED
  INTERVIEW_SCHEDULED
  MEDICAL_REQUESTED
  MEDICAL_SUBMITTED
  MEDICAL_APPROVED
  CONTRACT_SENT
  CONTRACT_SIGNED
  VISA_APPLIED
  VISA_APPROVED
  FLIGHT_TICKET_SENT
  FLIGHT_TICKET_RECEIVED
  DEPLOYMENT_READY
}

// Update ApplicationStatus enum
enum ApplicationStatus {
  PENDING
  UNDER_REVIEW
  SHORTLISTED
  INTERVIEW_SCHEDULED
  MEDICAL_PENDING
  CONTRACT_PENDING
  VISA_PROCESSING
  FLIGHT_PENDING
  READY_FOR_DEPLOYMENT
  COMPLETED
  REJECTED
  WITHDRAWN
}

model Contract {
  id              String    @id @default(cuid())
  applicationId   String    @unique
  application     JobApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  employerId      String
  employer        User      @relation("EmployerContracts", fields: [employerId], references: [id])
  employeeId      String
  employee        User      @relation("EmployeeContracts", fields: [employeeId], references: [id])
  
  content         String    @db.Text // HTML content
  pdfUrl          String?
  
  // Signatures
  employerSigned  Boolean   @default(false)
  employerSignedAt DateTime?
  employerSignature String? // Digital signature hash/image
  
  employeeSigned  Boolean   @default(false)
  employeeSignedAt DateTime?
  employeeSignature String?
  
  adminSigned     Boolean   @default(false)
  adminSignedAt   DateTime?
  adminSignature  String?
  
  status          ContractStatus @default(DRAFT)
  flightTickets   FlightTicket[]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@map("contracts")
}

model Notification {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String
  message     String
  type        NotificationType
  read        Boolean   @default(false)
  actionUrl   String?
  metadata    Json?
  
  createdAt   DateTime  @default(now())
  
  @@map("notifications")
}

enum ContractStatus {
  DRAFT
  PENDING_SIGNATURES
  SIGNED
  TERMINATED
  EXPIRED
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  JOB_ALERT
  APPLICATION_UPDATE
  CONTRACT_UPDATE
  PAYMENT_RECEIVED
  SUPPORT_TICKET
  TRAINING_COMPLETE
  SHORTLISTED
  CONTRACT_GENERATED
  FLIGHT_TICKET_UPLOADED
  SYSTEM
}

// Wallet & Payment Models
model Wallet {
  id          String    @id @default(cuid())
  userId      String    @unique
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  balance     Float     @default(0)
  currency    String    @default("OMR")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@map("wallets")
}

model Transaction {
  id              String          @id @default(cuid())
  amount          Float
  currency        String          @default("OMR")
  type            TransactionType
  status          TransactionStatus @default(PENDING)
  description     String?
  reference       String?         @unique
  
  senderId        String?
  sender          User?           @relation("SenderTransactions", fields: [senderId], references: [id])
  receiverId      String?
  receiver        User?           @relation("ReceiverTransactions", fields: [receiverId], references: [id])
  
  metadata        Json?           // Store additional payment details
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@map("transactions")
}

enum TransactionType {
  VERIFICATION_FEE
  SALARY_PAYMENT
  WITHDRAWAL
  REFUND
  PENALTY
  BONUS
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

// Support Ticket Models
model SupportTicket {
  id          String       @id @default(cuid())
  ticketNumber String      @unique
  subject     String
  description String       @db.Text
  status      TicketStatus @default(OPEN)
  priority    TicketPriority @default(MEDIUM)
  category    TicketCategory
  
  creatorId   String
  creator     User         @relation("TicketCreator", fields: [creatorId], references: [id])
  
  assignedToId String?
  assignedTo  User?        @relation("TicketAssignee", fields: [assignedToId], references: [id])
  
  messages    TicketMessage[]
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  @@map("support_tickets")
}

model TicketMessage {
  id          String        @id @default(cuid())
  ticketId    String
  ticket      SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  senderId    String
  sender      User          @relation(fields: [senderId], references: [id])
  
  message     String        @db.Text
  isInternal  Boolean       @default(false) // Admin-only notes
  
  createdAt   DateTime      @default(now())
  
  @@map("ticket_messages")
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_FOR_CUSTOMER
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketCategory {
  TECHNICAL
  BILLING
  ACCOUNT
  VERIFICATION
  JOB_DISPUTE
  OTHER
}

enum EscalationLevel {
  SUPPORT
  MANAGER
  LEGAL
  EMERGENCY
  COURT
}

// Training & Classes Models
model TrainingClass {
  id              String          @id @default(cuid())
  title           String
  description     String          @db.Text
  videoUrl        String
  thumbnailUrl    String?
  duration        Int             // in seconds
  category        String
  order           Int             @default(0)
  
  questions       TestQuestion[]
  progress        ClassProgress[]
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@map("training_classes")
}

model ClassProgress {
  id              String        @id @default(cuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  classId         String
  class           TrainingClass @relation(fields: [classId], references: [id], onDelete: Cascade)
  
  watchedDuration Int           @default(0) // in seconds
  completed       Boolean       @default(false)
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@unique([userId, classId])
  @@map("class_progress")
}

model TestQuestion {
  id              String        @id @default(cuid())
  classId         String
  class           TrainingClass @relation(fields: [classId], references: [id], onDelete: Cascade)
  
  question        String        @db.Text
  options         Json          // Array of options
  correctAnswer   Int           // Index of correct option
  explanation     String?       @db.Text
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@map("test_questions")
}

model TestAttempt {
  id              String        @id @default(cuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  classId         String
  
  answers         Json          // User's answers
  score           Float         // Percentage score
  passed          Boolean       // true if score >= 90%
  
  createdAt       DateTime      @default(now())
  
  @@map("test_attempts")
}

model SalaryConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       Float
  description String?
  updatedAt   DateTime @updatedAt

  @@map("salary_configs")
}

model FlightTicket {
  id            String   @id @default(cuid())
  contractId    String
  contract      Contract @relation(fields: [contractId], references: [id])
  fileUrl       String
  airline       String?
  flightNumber  String?
  departureDate DateTime?
  arrivalDate   DateTime?
  price         Float?
  currency      String   @default("OMR")
  createdAt     DateTime @default(now())

  @@map("flight_tickets")
}

model PaymentTransaction {
  id            String   @id @default(cuid())
  amount        Float
  currency      String   @default("OMR")
  status        String
  provider      String
  reference     String?
  metadata      Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("payment_transactions")
}

enum PetType {
  DOG
  CAT
  BIRD
  REPTILE
  FISH
  OTHER
}

enum PetHousing {
  CAGED
  FREE
  HYBRID
}

enum HouseFeature {
  SMALL_COMPOUND
  MEDIUM_COMPOUND
  LARGE_COMPOUND
  SWIMMING_POOL
  VEGETABLE_GARDEN
  FLOWER_GARDEN
  GRASS_GARDEN
  KIDS_PLAYGROUND
}

enum DisabilityLevel {
  MILD
  MODERATE
  SEVERE
  COMPLETE
}