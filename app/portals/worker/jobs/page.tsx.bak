"use client"

import { useEffect, useState } from "react"
import { useRouter } from "next/navigation"
import { LoadingSpinner } from "@/components/loading-spinner"
import { Progress } from "@/components/ui/progress"
import {
  Briefcase,
  FileText,
  MapPin,
  DollarSign,
  Clock,
  Users,
  Calendar,
  Zap,
  Filter,
  Bookmark,
  Eye,
  Heart,
  Utensils,
  Car,
  Video,
  Home as HomeIcon,
  Baby,
  Sprout,
  Shirt,
  Coffee,
  Dog,
  Sparkles,
  AlertCircle,
  User,
  Star,
  CheckCircle,
  Clock4,
  BookmarkCheck,
  MoreHorizontal,
  ChevronRight,
  Building,
  Award,
  Shield,
  GraduationCap,
  Users as UsersIcon,
  Crown,
  Plane,
  Download,
  Upload,
  MessageCircle,
  Stethoscope,
  FileCheck,
  ShieldCheck,
  UserCheck
} from "lucide-react"
import { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Badge } from "@/components/ui/badge"
import { Input } from "@/components/ui/input"
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from "@/components/ui/dialog"
import { Label } from "@/components/ui/label"
import { Textarea } from "@/components/ui/textarea"
import { useTheme } from "@/contexts/ThemeContext"
import { cn } from "@/lib/utils"
import { jobService } from "@/lib/services/jobService"
import { ApplicationStepper } from "@/components/application-stepper"

// Filter options
const FILTER_OPTIONS = {
  ALL: "all",
  NO_KIDS: "no_kids",
  SMALL_FAMILY: "small_family",
  MEDIUM_FAMILY: "medium_family",
  LARGE_FAMILY: "large_family",
  LOWEST_PAY: "lowest_pay",
  HIGHEST_PAY: "highest_pay"
}

export default function WorkerJobsPage() {
  const router = useRouter()
  const { currentTheme } = useTheme()
  const [user, setUser] = useState<any>(null)
  const [loading, setLoading] = useState(true)
  const [activeTab, setActiveTab] = useState("browse")
  const [jobs, setJobs] = useState<any[]>([])
  const [savedJobsList, setSavedJobsList] = useState<any[]>([])
  const [applications, setApplications] = useState<any[]>([])
  const [currentPage, setCurrentPage] = useState(1)
  const [isLoadingMore, setIsLoadingMore] = useState(false)
  const [activeFilter, setActiveFilter] = useState(FILTER_OPTIONS.ALL)
  const [uploadingDocument, setUploadingDocument] = useState<string | null>(null)

  // Apply Modal State
  const [showApplyModal, setShowApplyModal] = useState(false)
  const [selectedJobForApply, setSelectedJobForApply] = useState<any>(null)
  const [applicationForm, setApplicationForm] = useState({
    coverLetter: ""
  })

  const jobsPerPage = 6

  useEffect(() => {
    const loadData = async () => {
      setLoading(true)

      const userData = sessionStorage.getItem("user")
      if (!userData) {
        router.push("/login")
        return
      }

      const parsedUser = JSON.parse(userData)
      if (parsedUser.role !== "EMPLOYEE") {
        router.push("/login")
        return
      }

      setUser(parsedUser)

      try {
        // Load jobs
        const jobsData = await jobService.getJobs({ role: 'employee' })
        setJobs(jobsData.jobs || [])

        // Load applications with detailed progress
        const applicationsData = await jobService.getApplications({ role: 'employee' })
        setApplications(applicationsData || [])

        // Load saved jobs
        const savedJobsData = await jobService.getSavedJobs()
        setSavedJobsList(savedJobsData.map((item: any) => ({
          ...item.job,
          saved: true,
          applied: applicationsData?.some((app: any) => app.jobId === item.job.id) || false
        })) || [])

      } catch (error) {
        console.error('Error loading data:', error)
        // Initialize empty arrays if API fails
        setJobs([])
        setApplications([])
        setSavedJobsList([])
      } finally {
        setLoading(false)
      }
    }

    loadData()
  }, [router])

  // Refresh applications data
  const refreshApplications = async () => {
    try {
      const applicationsData = await jobService.getApplications({ role: 'employee' })
      setApplications(applicationsData || [])
    } catch (error) {
      console.error('Error refreshing applications:', error)
    }
  }

  // Filter jobs based on active filter
  const filteredJobs = jobs.filter(job => {
    switch (activeFilter) {
      case FILTER_OPTIONS.NO_KIDS:
        return job.childrenCount === 0
      case FILTER_OPTIONS.SMALL_FAMILY:
        return job.familyMembers <= 2
      case FILTER_OPTIONS.MEDIUM_FAMILY:
        return job.familyMembers > 2 && job.familyMembers <= 4
      case FILTER_OPTIONS.LARGE_FAMILY:
        return job.familyMembers > 4
      case FILTER_OPTIONS.LOWEST_PAY:
        return job.salary <= 400
      case FILTER_OPTIONS.HIGHEST_PAY:
        return job.salary >= 500
      default:
        return true
    }
  })

  // Sort jobs for salary filters
  const sortedJobs = [...filteredJobs].sort((a, b) => {
    if (activeFilter === FILTER_OPTIONS.LOWEST_PAY) {
      return a.salary - b.salary
    } else if (activeFilter === FILTER_OPTIONS.HIGHEST_PAY) {
      return b.salary - a.salary
    }
    return 0
  })

  // Simulate loading more jobs
  const loadMoreJobs = async () => {
    setIsLoadingMore(true)
    await new Promise(resolve => setTimeout(resolve, 1000))
    setCurrentPage(prev => prev + 1)
    setIsLoadingMore(false)
  }

  const handleApply = (job: any) => {
    setSelectedJobForApply(job)
    setApplicationForm({ coverLetter: "" })
    setShowApplyModal(true)
  }

  const submitApplication = async (isDraft: boolean = false) => {
    if (!selectedJobForApply) return

    try {
      const response = await jobService.createApplication(
        selectedJobForApply.id,
        applicationForm.coverLetter,
        isDraft
      )

      // Update jobs list to reflect applied status
      const updatedJobs = jobs.map((j: any) =>
        j.id === selectedJobForApply.id ? { ...j, applied: !isDraft } : j
      )
      setJobs(updatedJobs)

      // Update saved jobs list to reflect applied status
      const updatedSavedJobs = savedJobsList.map((j: any) =>
        j.id === selectedJobForApply.id ? { ...j, applied: !isDraft } : j
      )
      setSavedJobsList(updatedSavedJobs)

      // Refresh applications
      await refreshApplications()

      setShowApplyModal(false)
      setSelectedJobForApply(null)

      if (isDraft) {
        alert('Application saved as draft!')
      } else {
        alert('Application submitted successfully!')
      }
    } catch (error) {
      console.error('Error applying to job:', error)
      alert('Failed to submit application. Please try again.')
    }
  }

  const handleSaveJob = async (jobId: string) => {
    try {
      const job = jobs.find(j => j.id === jobId)
      const isCurrentlySaved = savedJobsList.some(j => j.id === jobId)

      if (isCurrentlySaved) {
        await jobService.unsaveJob(jobId)
        setSavedJobsList(prev => prev.filter(j => j.id !== jobId))
      } else {
        await jobService.saveJob(jobId)
        if (job) {
          setSavedJobsList(prev => [...prev, {
            ...job,
            saved: true,
            applied: applications.some(app => app.jobId === jobId)
          }])
        }
      }

      // Update jobs list
      setJobs(prev => prev.map(job =>
        job.id === jobId ? { ...job, saved: !isCurrentlySaved } : job
      ))

    } catch (error) {
      console.error('Error saving job:', error)
      alert('Failed to save job. Please try again.')
    }
  }

  // Handle medical document upload
  const handleMedicalUpload = async (applicationId: string) => {
    const input = document.createElement('input')
    input.type = 'file'
    input.accept = '.pdf,.jpg,.jpeg,.png,.doc,.docx'
    input.onchange = async (e) => {
      const file = (e.target as HTMLInputElement).files?.[0]
      if (file) {
        setUploadingDocument(applicationId)
        try {
          await jobService.uploadMedicalDocument(applicationId, file)
          await refreshApplications()
          alert('Medical document uploaded successfully!')
        } catch (error) {
          console.error('Error uploading medical document:', error)
          alert('Failed to upload medical document. Please try again.')
        } finally {
          setUploadingDocument(null)
        }
      }
    }
    input.click()
  }

  // Handle contract signing
  const handleContractSign = async (applicationId: string) => {
    try {
      await jobService.updateApplicationStep(applicationId, 'CONTRACT_SIGNED')
      await refreshApplications()
      alert('Contract signed successfully!')
    } catch (error) {
      console.error('Error signing contract:', error)
      alert('Failed to sign contract. Please try again.')
    }
  }

  // Handle flight ticket confirmation
  const handleFlightConfirmation = async (applicationId: string) => {
    try {
      await jobService.updateApplicationStep(applicationId, 'FLIGHT_TICKET_RECEIVED')
      await refreshApplications()
      alert('Flight ticket confirmed!')
    } catch (error) {
      console.error('Error confirming flight ticket:', error)
      alert('Failed to confirm flight ticket. Please try again.')
    }
  }

  const getCategoryIcon = (category: string) => {
    switch (category) {
      case "House Management":
        return HomeIcon
      case "Childcare":
        return Baby
      case "Elderly Care":
        return Heart
      case "Cooking":
        return Utensils
      case "Gardening":
        return Sprout
      case "Cleaning":
        return Shirt
      case "Pet Care":
        return Dog
      case "Driving":
        return Car
      case "Laundry":
        return Sparkles
      default:
        return Briefcase
    }
  }

  const getStatusBadge = (status: string) => {
    switch (status) {
      case "UNDER_REVIEW":
        return <Badge variant="secondary" className="bg-blue-100 text-blue-700 border-0"><Clock4 className="h-3 w-3 mr-1" />Under Review</Badge>
      case "PENDING_DETAILS":
        return <Badge variant="secondary" className="bg-amber-100 text-amber-700 border-0"><AlertCircle className="h-3 w-3 mr-1" />More Info Needed</Badge>
      case "ACCEPTED":
        return <Badge variant="secondary" className="bg-green-100 text-green-700 border-0"><CheckCircle className="h-3 w-3 mr-1" />Accepted</Badge>
      case "REJECTED":
        return <Badge variant="secondary" className="bg-red-100 text-red-700 border-0"><AlertCircle className="h-3 w-3 mr-1" />Rejected</Badge>
      case "SHORTLISTED":
        return <Badge variant="secondary" className="bg-purple-100 text-purple-700 border-0"><Star className="h-3 w-3 mr-1" />Shortlisted</Badge>
      case "CONTRACT_PENDING":
        return <Badge variant="secondary" className="bg-orange-100 text-orange-700 border-0"><FileText className="h-3 w-3 mr-1" />Contract Pending</Badge>
      case "VISA_PROCESSING":
        return <Badge variant="secondary" className="bg-indigo-100 text-indigo-700 border-0"><Shield className="h-3 w-3 mr-1" />Visa Processing</Badge>
      case "READY_FOR_DEPLOYMENT":
        return <Badge variant="secondary" className="bg-green-100 text-green-700 border-0"><CheckCircle className="h-3 w-3 mr-1" />Ready for Deployment</Badge>
      default:
        return <Badge variant="secondary" className="border-0">Pending</Badge>
    }
  }

  const getFamilySizeIcon = (size: string) => {
    switch (size) {
      case "single":
        return <User className="h-4 w-4" />
      case "small":
        return <UsersIcon className="h-4 w-4" />
      case "medium":
        return <Users className="h-4 w-4" />
      case "large":
        return <Users className="h-4 w-4" />
      default:
        return <UsersIcon className="h-4 w-4" />
    }
  }

  const getFamilySizeColor = (size: string) => {
    switch (size) {
      case "single":
        return "text-gray-600 bg-gray-100"
      case "small":
        return "text-green-600 bg-green-100"
      case "medium":
        return "text-blue-600 bg-blue-100"
      case "large":
        return "text-purple-600 bg-purple-100"
      default:
        return "text-gray-600 bg-gray-100"
    }
  }

  const getJobType = (type: string) => {
    switch (type) {
      case "FULL_TIME":
        return "Full-time"
      case "PART_TIME":
        return "Part-time"
      case "LIVE_OUT":
        return "Live-out"
      case "FLEXIBLE":
        return "Flexible"
      default:
        return type
    }
  }

  const getResidenceType = (type: string) => {
    switch (type) {
      case "APARTMENT":
        return "Apartment"
      case "VILLA":
        return "Villa"
      case "DUPLEX":
        return "Duplex"
      case "MANSION":
        return "Mansion"
      default:
        return type
    }
  }

  const calculateMatchScore = (job: any) => {
    // Simple match score calculation based on job requirements
    let score = 70 // Base score

    // Add points for various factors
    if (job.salary >= 400) score += 10
    if (job.benefits && job.benefits.length > 2) score += 10
    if (job.vacationDays > 25) score += 5
    if (job.accommodation === "PRIVATE") score += 5

    return Math.min(score, 95) // Cap at 95%
  }

  // Get applications that require action
  const getPendingApplications = () => {
    return applications.filter(app =>
      app.currentStep === 'MEDICAL_REQUESTED' && !app.medicalSubmitted ||
      app.currentStep === 'CONTRACT_SENT' && !app.contractSigned ||
      app.currentStep === 'FLIGHT_TICKET_SENT' && !app.flightTicketReceivedAt
    )
  }

  // Skeleton loading component
  const JobCardSkeleton = () => (
    <Card className="border-0 shadow-lg animate-pulse bg-white/80 backdrop-blur-sm">
      <CardHeader className="pb-4">
        <div className="flex items-start justify-between mb-3">
          <div className="h-12 w-12 bg-gray-200 rounded-xl"></div>
          <div className="h-6 w-16 bg-gray-200 rounded"></div>
        </div>
        <div className="h-6 bg-gray-200 rounded mb-2"></div>
        <div className="h-4 bg-gray-200 rounded w-3/4"></div>
      </CardHeader>
      <CardContent className="space-y-4">
        <div className="h-4 bg-gray-200 rounded"></div>
        <div className="flex justify-between">
          <div className="h-4 bg-gray-200 rounded w-1/3"></div>
          <div className="h-4 bg-gray-200 rounded w-1/4"></div>
        </div>
        <div className="space-y-2">
          <div className="h-4 bg-gray-200 rounded w-1/2"></div>
          <div className="flex gap-2">
            <div className="h-6 bg-gray-200 rounded w-16"></div>
            <div className="h-6 bg-gray-200 rounded w-20"></div>
          </div>
        </div>
      </CardContent>
      <CardFooter>
        <div className="h-10 bg-gray-200 rounded flex-1"></div>
        <div className="h-10 bg-gray-200 rounded w-10 ml-2"></div>
      </CardFooter>
    </Card>
  )

  if (loading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50/30 p-6">
        <div className="max-w-7xl mx-auto space-y-6">
          {/* Header Skeleton */}
          <div className="text-center space-y-3 animate-pulse">
            <div className="h-10 bg-gray-200 rounded w-1/3 mx-auto"></div>
            <div className="h-6 bg-gray-200 rounded w-1/2 mx-auto"></div>
          </div>

          {/* Filters Skeleton */}
          <div className="h-16 bg-gray-200 rounded-xl"></div>

          {/* Tabs Skeleton */}
          <div className="h-12 bg-gray-200 rounded-lg"></div>

          {/* Jobs Grid Skeleton */}
          <div className="grid gap-6 md:grid-cols-2 xl:grid-cols-3">
            {[...Array(6)].map((_, i) => (
              <JobCardSkeleton key={i} />
            ))}
          </div>
        </div>
      </div>
    )
  }

  if (!user) {
    return <LoadingSpinner />
  }

  const displayedJobs = sortedJobs.slice(0, currentPage * jobsPerPage)
  const hasMoreJobs = displayedJobs.length < sortedJobs.length
  const pendingApplications = getPendingApplications()

  const hiringSteps = [
    { step: 1, status: 'PENDING', title: 'Application Received', description: 'Candidate has applied', icon: FileText },
    { step: 2, status: 'UNDER_REVIEW', title: 'Interview Stage', description: 'Schedule and conduct interviews', icon: Video }, // Note: Video icon needs import if not present, or use Camera/User
    { step: 3, status: 'SHORTLISTED', title: 'Shortlisted', description: 'Candidate selected for the role', icon: Star },
    { step: 4, status: 'CONTRACT_SENT', title: 'Contract Sent', description: 'Digital contract prepared', icon: FileCheck },
    { step: 5, status: 'VISA_PROCESSING', title: 'Visa Processing', description: 'Work visa application', icon: ShieldCheck },
    { step: 6, status: 'FLIGHT_BOOKED', title: 'Flight Booked', description: 'Travel arrangements made', icon: Plane },
    { step: 7, status: 'ARRIVED', title: 'Employee Arrived', description: 'Ready to start work', icon: UserCheck }
  ]

  return (
    <div className="min-h-screen" style={{ background: currentTheme.colors.background }}>
      <div className="max-w-7xl mx-auto p-6 space-y-8">
        {/* Pending Actions Alert */}
        {pendingApplications.length > 0 && (
          <Card className="border-2 border-amber-200 bg-amber-50/80 backdrop-blur-sm rounded-2xl">
            <CardContent className="p-6">
              <div className="flex items-center gap-4">
                <div className="flex h-12 w-12 items-center justify-center rounded-xl bg-amber-100">
                  <AlertCircle className="h-6 w-6 text-amber-600" />
                </div>
                <div className="flex-1">
                  <h3 className="text-lg font-semibold text-amber-800 mb-1">
                    Action Required on {pendingApplications.length} Application{pendingApplications.length !== 1 ? 's' : ''}
                  </h3>
                  <p className="text-amber-700 text-sm">
                    You have pending actions that need your attention to move forward with your applications.
                  </p>
                </div>
                <Button
                  onClick={() => setActiveTab("applications")}
                  className="bg-amber-500 hover:bg-amber-600 text-white rounded-xl"
                >
                  Review Applications
                </Button>
              </div>
            </CardContent>
          </Card>
        )}

        {/* Filter Section (Simplified) */}
        <div className="bg-card/80 backdrop-blur-sm rounded-2xl p-6 shadow-xl border">
          <div className="flex flex-col md:flex-row gap-4 items-center justify-between">
            <div className="flex-1 w-full md:w-auto">
              <h3 className="text-lg font-semibold text-card-foreground mb-4 flex items-center gap-2">
                <Filter className="h-5 w-5" />
                Filter Opportunities
              </h3>
              <div className="flex gap-4 overflow-x-auto pb-2">
                <Select value={activeFilter} onValueChange={setActiveFilter}>
                  <SelectTrigger className="w-[180px]">
                    <SelectValue placeholder="Filter by..." />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value={FILTER_OPTIONS.ALL}>All Jobs</SelectItem>
                    <SelectItem value={FILTER_OPTIONS.NO_KIDS}>No Kids</SelectItem>
                    <SelectItem value={FILTER_OPTIONS.SMALL_FAMILY}>Small Family (1-2)</SelectItem>
                    <SelectItem value={FILTER_OPTIONS.MEDIUM_FAMILY}>Medium Family (3-4)</SelectItem>
                    <SelectItem value={FILTER_OPTIONS.LARGE_FAMILY}>Large Family (5+)</SelectItem>
                    <SelectItem value={FILTER_OPTIONS.HIGHEST_PAY}>Highest Pay</SelectItem>
                  </SelectContent>
                </Select>

                <Badge variant="secondary" className="px-4 py-2 bg-primary/10 text-primary border-0 h-10">
                  <Briefcase className="h-4 w-4 mr-1" />
                  {sortedJobs.length} Opportunities
                </Badge>
              </div>
            </div>
          </div>
        </div>

        {/* Main Content with Tabs */}
        <Tabs value={activeTab} onValueChange={setActiveTab} className="space-y-6">
          <TabsList className="grid w-full grid-cols-4 p-1 bg-card/80 backdrop-blur-sm rounded-2xl border">
            <TabsTrigger
              value="browse"
              className="rounded-xl data-[state=active]:bg-primary data-[state=active]:text-primary-foreground"
              style={{
                backgroundColor: activeTab === "browse" ? currentTheme.colors.primary : 'transparent',
                color: activeTab === "browse" ? currentTheme.colors.text : currentTheme.colors.text
              }}
            >
              <Briefcase className="h-4 w-4 mr-2" />
              Browse Jobs
              <Badge variant="secondary" className="ml-2 bg-white/20 text-white text-xs">
                {sortedJobs.length}
              </Badge>
            </TabsTrigger>
            <TabsTrigger
              value="applications"
              className="rounded-xl data-[state=active]:bg-primary data-[state=active]:text-primary-foreground"
              style={{
                backgroundColor: activeTab === "applications" ? currentTheme.colors.primary : 'transparent',
                color: activeTab === "applications" ? currentTheme.colors.text : currentTheme.colors.text
              }}
            >
              <FileText className="h-4 w-4 mr-2" />
              My Applications
              <Badge variant="secondary" className="ml-2 bg-white/20 text-white text-xs">
                {applications.length}
              </Badge>
            </TabsTrigger>
            <TabsTrigger
              value="pending"
              className="rounded-xl data-[state=active]:bg-primary data-[state=active]:text-primary-foreground"
              style={{
                backgroundColor: activeTab === "pending" ? currentTheme.colors.primary : 'transparent',
                color: activeTab === "pending" ? currentTheme.colors.text : currentTheme.colors.text
              }}
            >
              <Clock4 className="h-4 w-4 mr-2" />
              Pending Actions
              {pendingApplications.length > 0 && (
                <Badge variant="destructive" className="ml-2 bg-red-500 text-white text-xs">
                  {pendingApplications.length}
                </Badge>
              )}
            </TabsTrigger>
            <TabsTrigger
              value="saved"
              className="rounded-xl data-[state=active]:bg-primary data-[state=active]:text-primary-foreground"
              style={{
                backgroundColor: activeTab === "saved" ? currentTheme.colors.primary : 'transparent',
                color: activeTab === "saved" ? currentTheme.colors.text : currentTheme.colors.text
              }}
            >
              <BookmarkCheck className="h-4 w-4 mr-2" />
              Saved Jobs
              <Badge variant="secondary" className="ml-2 bg-white/20 text-white text-xs">
                {savedJobsList.length}
              </Badge>
            </TabsTrigger>
          </TabsList>

          {/* Browse Jobs Tab */}
          <TabsContent value="browse" className="space-y-6">
            <div className="grid gap-6 md:grid-cols-2 xl:grid-cols-3">
              {displayedJobs.map((job) => {
                const matchScore = calculateMatchScore(job)
                const applied = applications.some(app => app.jobId === job.id)
                const saved = savedJobsList.some(savedJob => savedJob.id === job.id)
                const CategoryIcon = getCategoryIcon(job.duties?.[0] || "General")

                return (
                  <Card key={job.id} className="group relative overflow-hidden border-0 shadow-lg hover:shadow-2xl transition-all duration-500 bg-card/80 backdrop-blur-sm">
                    {/* Match Score Badge */}
                    <div className="absolute top-4 right-4 z-10">
                      <Badge className="bg-green-500 text-white px-2 py-1 text-xs">
                        {matchScore}% Match
                      </Badge>
                    </div>

                    {/* Urgent Badge */}
                    {job.urgent && (
                      <div className="absolute top-4 left-4 z-10 animate-pulse">
                        <Badge variant="destructive" className="px-2 py-1 text-xs">
                          <Zap className="h-3 w-3 mr-1" />
                          URGENT
                        </Badge>
                      </div>
                    )}

                    <CardHeader className="pb-4">
                      <div className="flex items-start justify-between mb-4">
                        <div className="flex h-14 w-14 items-center justify-center rounded-2xl bg-primary/10">
                          <CategoryIcon className="h-7 w-7 text-primary" />
                        </div>
                        <Badge variant={job.urgent ? "destructive" : "secondary"} className="text-xs border-0">
                          {getJobType(job.type)}
                        </Badge>
                      </div>

                      <CardTitle className="text-xl leading-tight group-hover:text-primary transition-colors line-clamp-2">
                        {job.title}
                      </CardTitle>

                      <CardDescription className="flex items-center gap-2 mt-3">
                        <Building className="h-4 w-4" />
                        <span className="font-medium text-card-foreground">
                          {job.employer?.firstName} {job.employer?.lastName}
                        </span>
                        <div className="flex items-center gap-1 ml-2">
                          <Star className="h-3 w-3 fill-yellow-400 text-yellow-400" />
                          <span className="text-sm font-semibold">4.5</span>
                          <span className="text-xs text-muted-foreground">(12)</span>
                        </div>
                      </CardDescription>
                    </CardHeader>

                    <CardContent className="space-y-4">
                      <p className="text-muted-foreground leading-relaxed line-clamp-2">
                        {job.description}
                      </p>

                      {/* Family Info */}
                      <div className="flex items-center gap-4 text-sm">
                        <Badge variant="outline" className={cn("px-2 py-1 text-xs", getFamilySizeColor(
                          job.familyMembers <= 2 ? "small" :
                            job.familyMembers <= 4 ? "medium" : "large"
                        ))}>
                          {getFamilySizeIcon(
                            job.familyMembers <= 2 ? "small" :
                              job.familyMembers <= 4 ? "medium" : "large"
                          )}
                          <span className="ml-1 capitalize">
                            {job.familyMembers <= 2 ? "Small" :
                              job.familyMembers <= 4 ? "Medium" : "Large"} Family
                          </span>
                        </Badge>
                        {job.childrenCount > 0 && (
                          <Badge variant="outline" className="px-2 py-1 text-xs bg-amber-100 text-amber-700 border-0">
                            <Baby className="h-3 w-3 mr-1" />
                            {job.childrenCount} children
                          </Badge>
                        )}
                      </div>

                      <div className="flex items-center justify-between text-sm">
                        <div className="flex items-center gap-2">
                          <MapPin className="h-4 w-4 text-muted-foreground" />
                          <span className="font-semibold text-card-foreground">{job.city}</span>
                        </div>
                        <div className="flex items-center gap-2">
                          <DollarSign className="h-4 w-4 text-green-500" />
                          <span className="font-bold text-green-600">{job.salary} {job.salaryCurrency}</span>
                        </div>
                      </div>

                      <div className="flex items-center justify-between text-xs text-muted-foreground">
                        <div className="flex items-center gap-4">
                          <div className="flex items-center gap-1">
                            <Users className="h-3 w-3" />
                            {job._count?.applications || 0} applied
                          </div>
                          <div className="flex items-center gap-1">
                            <Eye className="h-3 w-3" />
                            {job._count?.views || 0} views
                          </div>
                        </div>
                        <div className="flex items-center gap-1">
                          <Calendar className="h-3 w-3" />
                          {new Date(job.postedAt || job.createdAt).toLocaleDateString()}
                        </div>
                      </div>
                    </CardContent>

                    <CardFooter className="flex gap-2 pt-4">
                      <Button
                        className="flex-1 transition-all duration-300 hover:scale-105 bg-primary hover:bg-primary/90 text-primary-foreground rounded-xl"
                        onClick={() => handleApply(job)}
                        disabled={applied}
                      >
                        {applied ? (
                          <>
                            <CheckCircle className="h-4 w-4 mr-2" />
                            Applied
                          </>
                        ) : (
                          <>
                            <Briefcase className="h-4 w-4 mr-2" />
                            Apply Now
                          </>
                        )}
                      </Button>
                      <Button
                        variant={saved ? "default" : "outline"}
                        size="icon"
                        className="transition-all duration-300 hover:scale-110 rounded-xl"
                        onClick={() => handleSaveJob(job.id)}
                        style={{
                          backgroundColor: saved ? currentTheme.colors.primary : 'transparent',
                          color: saved ? currentTheme.colors.text : currentTheme.colors.text,
                          borderColor: currentTheme.colors.border
                        }}
                      >
                        <Bookmark className={`h-4 w-4 ${saved ? 'fill-white' : ''}`} />
                      </Button>
                    </CardFooter>

                    {/* Hover Effect */}
                    <div className="absolute inset-0 bg-gradient-to-br from-primary/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none rounded-2xl" />
                  </Card>
                )
              })}
            </div>

            {/* Load More Button */}
            {hasMoreJobs && (
              <div className="text-center">
                <Button
                  onClick={loadMoreJobs}
                  disabled={isLoadingMore}
                  variant="outline"
                  className="rounded-xl px-8 py-3 border-2 border-border hover:border-primary/50"
                >
                  {isLoadingMore ? (
                    <>
                      <div className="h-4 w-4 border-2 border-primary border-t-transparent rounded-full animate-spin mr-2" />
                      Loading...
                    </>
                  ) : (
                    <>
                      Load More Jobs
                      <ChevronRight className="h-4 w-4 ml-2" />
                    </>
                  )}
                </Button>
              </div>
            )}

            {/* Empty State */}
            {sortedJobs.length === 0 && (
              <Card className="border-0 shadow-xl text-center bg-card/80 backdrop-blur-sm">
                <CardContent className="py-20">
                  <div className="flex h-24 w-24 items-center justify-center rounded-full bg-muted mx-auto mb-6">
                    <Briefcase className="h-12 w-12 text-muted-foreground" />
                  </div>
                  <h3 className="text-2xl font-semibold text-card-foreground mb-3">No jobs found</h3>
                  <p className="text-muted-foreground mb-8 max-w-md mx-auto text-lg">
                    {activeFilter !== FILTER_OPTIONS.ALL ? "Try adjusting your filters to see more opportunities." : "Check back later for new domestic job opportunities."}
                  </p>
                  {activeFilter !== FILTER_OPTIONS.ALL && (
                    <Button
                      variant="outline"
                      onClick={() => setActiveFilter(FILTER_OPTIONS.ALL)}
                      className="rounded-xl border-2 border-border px-6 py-3"
                    >
                      Show All Jobs
                    </Button>
                  )}
                </CardContent>
              </Card>
            )}
          </TabsContent>

          {/* My Applications Tab */}
          <TabsContent value="applications" className="space-y-6">
            {applications.map((application) => (
              <Card key={application.id} className="border-0 shadow-lg bg-card/80 backdrop-blur-sm">
                <CardContent className="p-6">
                  <div className="flex items-start justify-between mb-4">
                    <div className="flex-1">
                      <div className="flex items-center gap-4 mb-3">
                        <div className="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center text-white font-semibold text-lg">
                          {application.job?.title?.split(' ').map((word: string) => word[0]).join('').toUpperCase()}
                        </div>
                        <div className="flex-1">
                          <h3 className="text-xl font-semibold text-card-foreground mb-1">
                            {application.job?.title}
                          </h3>
                          <div className="flex items-center gap-4 text-sm text-muted-foreground">
                            <span className="flex items-center gap-1">
                              <Building className="h-4 w-4" />
                              {application.job?.employer?.firstName} {application.job?.employer?.lastName}
                            </span>
                            <span className="flex items-center gap-1">
                              <MapPin className="h-4 w-4" />
                              {application.job?.city}
                            </span>
                            <span className="flex items-center gap-1">
                              <DollarSign className="h-4 w-4" />
                              {application.job?.salary} {application.job?.salaryCurrency}
                            </span>
                          </div>
                        </div>
                      </div>

                      {/* Application Status */}
                      <div className="flex items-center gap-4 mb-4">
                        {getStatusBadge(application.status)}
                        <span className="text-sm text-muted-foreground">
                          Applied {new Date(application.createdAt).toLocaleDateString()}
                        </span>
                      </div>

                      {/* Application Progress Stepper */}
                      <div className="mt-4">
                        <ApplicationStepper
                          currentStep={application.currentStep || 'APPLICATION_SUBMITTED'}
                          application={application}
                          role="employee"
                          onAction={async (step) => {
                            if (step === 'MEDICAL_REQUESTED') {
                              await handleMedicalUpload(application.id)
                            } else if (step === 'CONTRACT_SENT') {
                              await handleContractSign(application.id)
                            } else if (step === 'FLIGHT_TICKET_SENT') {
                              await handleFlightConfirmation(application.id)
                            }
                          }}
                        />
                      </div>
                    </div>
                  </div>

                  {/* Quick Actions based on current step */}
                  {application.currentStep === 'MEDICAL_REQUESTED' && !application.medicalSubmitted && (
                    <div className="p-4 bg-amber-50 rounded-lg border border-amber-200 mt-4">
                      <div className="flex items-center gap-3">
                        <Stethoscope className="h-5 w-5 text-amber-600" />
                        <div className="flex-1">
                          <h5 className="font-semibold text-amber-800">Medical Document Required</h5>
                          <p className="text-sm text-amber-700">Please upload your medical examination results to proceed with your application.</p>
                          <div className="flex gap-2 mt-3">
                            <Button
                              size="sm"
                              className="bg-amber-500 hover:bg-amber-600"
                              onClick={() => handleMedicalUpload(application.id)}
                              disabled={uploadingDocument === application.id}
                            >
                              {uploadingDocument === application.id ? (
                                <>
                                  <div className="h-3 w-3 border-2 border-white border-t-transparent rounded-full animate-spin mr-2" />
                                  Uploading...
                                </>
                              ) : (
                                <>
                                  <Upload className="h-4 w-4 mr-2" />
                                  Upload Medical Document
                                </>
                              )}
                            </Button>
                            <Button
                              variant="outline"
                              size="sm"
                              className="border-amber-300 text-amber-700 hover:bg-amber-100"
                              onClick={() => window.open('/medical-requirements', '_blank')}
                            >
                              <FileText className="h-4 w-4 mr-2" />
                              View Requirements
                            </Button>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}

                  {application.currentStep === 'CONTRACT_SENT' && application.contractUrl && !application.contractSigned && (
                    <div className="p-4 bg-blue-50 rounded-lg border border-blue-200 mt-4">
                      <div className="flex items-center gap-3">
                        <FileText className="h-5 w-5 text-blue-600" />
                        <div className="flex-1">
                          <h5 className="font-semibold text-blue-800">Contract Ready for Review</h5>
                          <p className="text-sm text-blue-700">Your employment contract has been sent. Please review and sign to proceed.</p>
                          <div className="flex gap-2 mt-3">
                            <Button
                              size="sm"
                              className="bg-blue-500 hover:bg-blue-600"
                              onClick={() => handleContractSign(application.id)}
                            >
                              <CheckCircle className="h-4 w-4 mr-2" />
                              Sign Contract
                            </Button>
                            <Button
                              variant="outline"
                              size="sm"
                              className="border-blue-300 text-blue-700 hover:bg-blue-100"
                              onClick={() => window.open(application.contractUrl, '_blank')}
                            >
                              <Download className="h-4 w-4 mr-2" />
                              Download Contract
                            </Button>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}

                  {application.currentStep === 'FLIGHT_TICKET_SENT' && application.flightTicketUrl && !application.flightTicketReceivedAt && (
                    <div className="p-4 bg-green-50 rounded-lg border border-green-200 mt-4">
                      <div className="flex items-center gap-3">
                        <Plane className="h-5 w-5 text-green-600" />
                        <div className="flex-1">
                          <h5 className="font-semibold text-green-800">Flight Ticket Available</h5>
                          <p className="text-sm text-green-700">Your flight ticket has been booked. Please review the details and confirm receipt.</p>
                          <div className="flex gap-2 mt-3">
                            <Button
                              size="sm"
                              className="bg-green-500 hover:bg-green-600"
                              onClick={() => handleFlightConfirmation(application.id)}
                            >
                              <CheckCircle className="h-4 w-4 mr-2" />
                              Confirm Receipt
                            </Button>
                            <Button
                              variant="outline"
                              size="sm"
                              className="border-green-300 text-green-700 hover:bg-green-100"
                              onClick={() => window.open(application.flightTicketUrl, '_blank')}
                            >
                              <Eye className="h-4 w-4 mr-2" />
                              View Flight Details
                            </Button>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Action Buttons */}
                  <div className="flex gap-2 mt-6 pt-4 border-t">
                    <Button variant="outline" size="sm">
                      <MessageCircle className="h-4 w-4 mr-2" />
                      Message Employer
                    </Button>
                    <Button variant="outline" size="sm">
                      <Eye className="h-4 w-4 mr-2" />
                      View Job Details
                    </Button>
                  </div>
                </CardContent>
              </Card>
            ))}

            {applications.length === 0 && (
              <Card className="border-0 shadow-xl text-center bg-card/80 backdrop-blur-sm">
                <CardContent className="py-16">
                  <FileText className="h-16 w-16 text-muted-foreground mx-auto mb-4" />
                  <h3 className="text-2xl font-semibold text-card-foreground mb-2">No Applications Yet</h3>
                  <p className="text-muted-foreground mb-6">Start applying to jobs to see them here.</p>
                  <Button
                    onClick={() => setActiveTab("browse")}
                    className="bg-primary hover:bg-primary/90 text-primary-foreground rounded-xl px-6 py-3"
                  >
                    Browse Jobs
                  </Button>
                </CardContent>
              </Card>
            )}
          </TabsContent>

          {/* Pending Actions Tab */}
          <TabsContent value="pending">
            <div className="space-y-4">
              {pendingApplications.map((application) => (
                <Card key={application.id} className="border-2 border-amber-200 bg-amber-50/50 backdrop-blur-sm">
                  <CardContent className="p-6">
                    <div className="flex items-start justify-between">
                      <div className="flex-1">
                        <div className="flex items-center gap-3 mb-3">
                          <AlertCircle className="h-5 w-5 text-amber-600" />
                          <div>
                            <h3 className="text-xl font-semibold text-amber-800">{application.job?.title}</h3>
                            <p className="text-amber-600 text-sm">
                              Employer: {application.job?.employer?.firstName} {application.job?.employer?.lastName}
                            </p>
                          </div>
                        </div>

                        {application.currentStep === 'MEDICAL_REQUESTED' && !application.medicalSubmitted && (
                          <div className="space-y-2">
                            <p className="text-amber-700">
                              <strong>Action Required:</strong> Upload medical examination results
                            </p>
                            <Button
                              size="sm"
                              className="bg-amber-500 hover:bg-amber-600"
                              onClick={() => handleMedicalUpload(application.id)}
                              disabled={uploadingDocument === application.id}
                            >
                              {uploadingDocument === application.id ? (
                                <>
                                  <div className="h-3 w-3 border-2 border-white border-t-transparent rounded-full animate-spin mr-2" />
                                  Uploading...
                                </>
                              ) : (
                                <>
                                  <Upload className="h-4 w-4 mr-2" />
                                  Upload Medical Document
                                </>
                              )}
                            </Button>
                          </div>
                        )}

                        {application.currentStep === 'CONTRACT_SENT' && application.contractUrl && !application.contractSigned && (
                          <div className="space-y-2">
                            <p className="text-amber-700">
                              <strong>Action Required:</strong> Review and sign employment contract
                            </p>
                            <div className="flex gap-2">
                              <Button
                                size="sm"
                                className="bg-amber-500 hover:bg-amber-600"
                                onClick={() => handleContractSign(application.id)}
                              >
                                <CheckCircle className="h-4 w-4 mr-2" />
                                Sign Contract
                              </Button>
                              <Button
                                variant="outline"
                                size="sm"
                                className="border-amber-300 text-amber-700 hover:bg-amber-100"
                                onClick={() => window.open(application.contractUrl, '_blank')}
                              >
                                <Download className="h-4 w-4 mr-2" />
                                View Contract
                              </Button>
                            </div>
                          </div>
                        )}

                        {application.currentStep === 'FLIGHT_TICKET_SENT' && application.flightTicketUrl && !application.flightTicketReceivedAt && (
                          <div className="space-y-2">
                            <p className="text-amber-700">
                              <strong>Action Required:</strong> Confirm flight ticket receipt
                            </p>
                            <div className="flex gap-2">
                              <Button
                                size="sm"
                                className="bg-amber-500 hover:bg-amber-600"
                                onClick={() => handleFlightConfirmation(application.id)}
                              >
                                <CheckCircle className="h-4 w-4 mr-2" />
                                Confirm Receipt
                              </Button>
                              <Button
                                variant="outline"
                                size="sm"
                                className="border-amber-300 text-amber-700 hover:bg-amber-100"
                                onClick={() => window.open(application.flightTicketUrl, '_blank')}
                              >
                                <Eye className="h-4 w-4 mr-2" />
                                View Ticket
                              </Button>
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                  </CardContent>
                </Card>
              ))}

              {pendingApplications.length === 0 && (
                <Card className="border-0 shadow-xl text-center bg-card/80 backdrop-blur-sm">
                  <CardContent className="py-16">
                    <CheckCircle className="h-16 w-16 text-green-400 mx-auto mb-4" />
                    <h3 className="text-2xl font-semibold text-card-foreground mb-2">All Caught Up!</h3>
                    <p className="text-muted-foreground">No pending actions required on your applications.</p>
                  </CardContent>
                </Card>
              )}
            </div>
          </TabsContent>

          {/* Saved Jobs Tab */}
          <TabsContent value="saved">
            <div className="grid gap-6 md:grid-cols-2 xl:grid-cols-3">
              {savedJobsList.map((job) => {
                const CategoryIcon = getCategoryIcon(job.duties?.[0] || "General")
                const applied = applications.some(app => app.jobId === job.id)
                const matchScore = calculateMatchScore(job)

                return (
                  <Card key={job.id} className="border-0 shadow-lg bg-card/80 backdrop-blur-sm group">
                    <CardHeader className="pb-4">
                      <div className="flex items-start justify-between mb-4">
                        <div className="flex h-14 w-14 items-center justify-center rounded-2xl bg-primary/10">
                          <CategoryIcon className="h-7 w-7 text-primary" />
                        </div>
                        <div className="flex gap-2">
                          <Badge className="bg-green-500 text-white text-xs">
                            {matchScore}% Match
                          </Badge>
                          <Button
                            variant="default"
                            size="icon"
                            className="bg-primary hover:bg-primary/90 rounded-xl"
                            onClick={() => handleSaveJob(job.id)}
                          >
                            <Bookmark className="h-4 w-4 fill-white" />
                          </Button>
                        </div>
                      </div>
                      <CardTitle className="text-xl leading-tight line-clamp-2">{job.title}</CardTitle>
                      <CardDescription className="flex items-center gap-2 mt-3">
                        <Building className="h-4 w-4" />
                        {job.employer?.firstName} {job.employer?.lastName}
                      </CardDescription>
                    </CardHeader>
                    <CardContent className="space-y-3">
                      <div className="flex items-center justify-between text-sm">
                        <div className="flex items-center gap-2">
                          <MapPin className="h-4 w-4 text-muted-foreground" />
                          <span>{job.city}</span>
                        </div>
                        <div className="flex items-center gap-2 text-green-600 font-semibold">
                          <DollarSign className="h-4 w-4" />
                          {job.salary} {job.salaryCurrency}
                        </div>
                      </div>
                      <div className="flex items-center gap-2 text-xs text-muted-foreground">
                        <Users className="h-3 w-3" />
                        {job._count?.applications || 0} applicants
                      </div>
                    </CardContent>
                    <CardFooter>
                      <Button
                        className="w-full bg-primary hover:bg-primary/90 text-primary-foreground rounded-xl"
                        onClick={() => handleApply(job)}
                        disabled={applied}
                      >
                        {applied ? (
                          <>
                            <CheckCircle className="h-4 w-4 mr-2" />
                            Applied
                          </>
                        ) : (
                          <>
                            <Briefcase className="h-4 w-4 mr-2" />
                            Apply Now
                          </>
                        )}
                      </Button>
                    </CardFooter>
                  </Card>
                )
              })}
              {savedJobsList.length === 0 && (
                <Card className="border-0 shadow-xl text-center bg-card/80 backdrop-blur-sm col-span-full">
                  <CardContent className="py-16">
                    <BookmarkCheck className="h-16 w-16 text-muted-foreground mx-auto mb-4" />
                    <h3 className="text-2xl font-semibold text-card-foreground mb-2">No Saved Jobs</h3>
                    <p className="text-muted-foreground mb-6">Save jobs you're interested in to apply later.</p>
                    <Button
                      onClick={() => setActiveTab("browse")}
                      className="bg-primary hover:bg-primary/90 text-primary-foreground rounded-xl px-6 py-3"
                    >
                      Browse Jobs
                    </Button>
                  </CardContent>
                </Card>
              )}
            </div>
          </TabsContent>
        </Tabs>

        {/* Profile Verification Alert */}
        <Card className="border-2 border-primary/20 bg-primary/5 backdrop-blur-sm rounded-2xl">
          <CardContent className="flex items-center gap-6 p-8">
            <div className="flex h-16 w-16 items-center justify-center rounded-2xl bg-primary/20">
              <Shield className="h-8 w-8 text-primary" />
            </div>
            <div className="flex-1">
              <h3 className="text-2xl font-semibold text-card-foreground mb-2">Boost Your Profile Visibility</h3>
              <p className="text-muted-foreground text-lg">
                Complete your profile verification to increase your chances of getting hired. Verified workers get 3x more responses from employers.
              </p>
            </div>
            <Button
              onClick={() => router.push("/portals/worker/onboarding")}
              className="bg-primary hover:bg-primary/90 text-primary-foreground rounded-xl px-8 py-3 text-lg"
            >
              Complete Profile
            </Button>
          </CardContent>
        </Card>
      </div>

      {/* Apply Modal */}
      <Dialog open={showApplyModal} onOpenChange={setShowApplyModal}>
        <DialogContent className="sm:max-w-[600px]">
          <DialogHeader>
            <DialogTitle>Apply for {selectedJobForApply?.title}</DialogTitle>
            <DialogDescription>
              Complete your application below. You can save as a draft to finish later.
            </DialogDescription>
          </DialogHeader>

          <div className="grid gap-4 py-4">
            <div className="grid gap-2">
              <Label htmlFor="cover">Cover Message</Label>
              <Textarea
                id="cover"
                placeholder="Introduce yourself and explain why you're a good fit..."
                className="h-32"
                value={applicationForm.coverLetter}
                onChange={(e) => setApplicationForm(prev => ({ ...prev, coverLetter: e.target.value }))}
              />
            </div>
          </div>

          <DialogFooter className="gap-2 sm:gap-0">
            <Button
              variant="outline"
              onClick={() => submitApplication(true)}
            >
              Save as Draft
            </Button>
            <Button
              onClick={() => submitApplication(false)}
              className="bg-primary hover:bg-primary/90"
            >
              Submit Application
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
    </div >
  )
}